import{u as we,r as t,j as h}from"./index-CN2M_2Wx.js";const ke="_bar_9cyg1_1",be="_cat_9cyg1_13",Ce="_fallingCatWrap_9cyg1_22",pe="_fallingMeatWrap_9cyg1_44",Ae="_fallingMeatEmoji_9cyg1_53",E={bar:ke,cat:be,fallingCatWrap:Ce,fallingMeatWrap:pe,fallingMeatEmoji:Ae},Ne="ğŸ—",Te=1800,He=12,Fe=13,$=13,b=7,C=1,ye=15,De=1e3/ye,Xe=1,se=1.5,Le=2,Oe=15e3,oe=2e3,je=3e3,Be=.5,ce=.4,$e=8e3,le=["walk","run","idle"];function Pe(){const{avatarClickCount:f,meatTargets:m,meatEatenCount:T,addMeatTarget:z,removeMeatTargetById:v}=we(),_=t.useRef(null),[r,H]=t.useState("hidden"),[c,W]=t.useState("walk"),[de,R]=t.useState({x:0,direction:"right",frameIndex:0,idleFrameIndex:0}),[g,fe]=t.useState(0),[l,ue]=t.useState(null),[n,he]=t.useState(null),P=t.useRef(c),F=t.useRef(g),y=t.useRef(l),D=t.useRef(n),U=t.useRef(r),K=t.useRef(m),q=t.useRef(T),p=t.useRef(f);P.current=c,F.current=g,y.current=l,D.current=n,U.current=r,K.current=m,q.current=T;const{x:X,direction:me,frameIndex:ge,idleFrameIndex:xe}=de,V=t.useCallback(()=>{W(le[Math.floor(Math.random()*le.length)]),R(e=>({...e,direction:Math.random()<.5?"left":"right"}))},[]),L=t.useCallback(()=>{_.current&&fe(_.current.clientWidth)},[]);t.useEffect(()=>{const e=new Image;e.onload=()=>{const s=e.naturalWidth,d=e.naturalHeight;ue({sheetWidth:s,sheetHeight:d,frameWidth:s/Fe,frameHeight:d})},e.src="/cat-walk.webp";const i=new Image;i.onload=()=>{const s=i.naturalWidth,d=i.naturalHeight,te=Math.floor(s/b),ne=Math.floor(d/C);he({sheetWidth:s,sheetHeight:d,frameWidth:te,frameHeight:ne,cols:b,rows:C})},i.src="/cat-idle.webp"},[]),t.useEffect(()=>{L();const e=new ResizeObserver(L);return _.current&&e.observe(_.current),()=>e.disconnect()},[L]),t.useEffect(()=>{f===0?H("hidden"):f>=1&&r==="hidden"&&H("falling")},[f]),t.useEffect(()=>{if(r!=="falling")return;const e=setTimeout(()=>H("onBar"),Te);return()=>clearTimeout(e)},[r]);const O=t.useRef(!1);t.useEffect(()=>{if(r==="onBar"&&!O.current&&g>0){O.current=!0;const e=l?.frameWidth??n?.frameWidth??40,i=Math.max(0,(g-e)/2);R(s=>({...s,x:i}))}r!=="onBar"&&(O.current=!1)},[r,g,l?.frameWidth,n?.frameWidth]),t.useEffect(()=>{if(f>=2&&f>p.current){p.current=f;const e=F.current,i=y.current?.frameWidth??D.current?.frameWidth??40,s=Math.max(0,e-i),d=s>0?Math.random()*s:0;z(d)}else f<p.current&&(p.current=f)},[f,z]);const G=c==="run"?l?.frameWidth??32:n?.frameWidth??32;t.useEffect(()=>{const e=Math.max(0,g-G);g>0&&X>e&&R(i=>({...i,x:e}))},[g,X,G]),t.useEffect(()=>{let e,i=null;const s=d=>{if(i==null&&(i=d),d-i<De){e=requestAnimationFrame(s);return}if(i=d,U.current!=="onBar"){e=requestAnimationFrame(s);return}const ae=P.current,I=F.current,N=y.current,re=D.current,M=K.current,Re=q.current,B=Math.min(1+Re*.2,2.2);R(a=>{if(M.length>0){let x=M[0].id,o=M[0].x;for(let k=1;k<M.length;k++)Math.abs(M[k].x-a.x)<Math.abs(o-a.x)&&(x=M[k].id,o=M[k].x);const u=o-a.x,ie=u>0?1:u<0?-1:0;let w=a.x+se*B*ie;const Se=I>0&&N?Math.max(0,I-N.frameWidth):0;return Math.abs(w-o)<He?(w=o,v(x)):w=Math.max(0,Math.min(Se,w)),{...a,x:w,direction:ie>=0?"right":"left",frameIndex:(a.frameIndex+1)%$}}if(ae==="run"){const x=I>0&&N?Math.max(0,I-N.frameWidth):0;let o=a.x+se*B*(a.direction==="right"?1:-1),u=a.direction;return o>=x&&(o=x,u="left"),o<=0&&(o=0,u="right"),{...a,frameIndex:(a.frameIndex+1)%$,x:o,direction:u}}if(ae==="walk"){const x=I>0&&re?Math.max(0,I-re.frameWidth):0;let o=a.x+Xe*B*(a.direction==="right"?1:-1),u=a.direction;return o>=x&&(o=x,u="left"),o<=0&&(o=0,u="right"),{...a,idleFrameIndex:(a.idleFrameIndex+Le)%(b*C),x:o,direction:u}}return{...a,idleFrameIndex:(a.idleFrameIndex+1)%(b*C)}}),e=requestAnimationFrame(s)};return e=requestAnimationFrame(s),()=>cancelAnimationFrame(e)},[v]),t.useEffect(()=>{if(m.length>0)return;let e=null;const i=setInterval(()=>{if((c==="walk"||c==="run")&&Math.random()<Be){R(d=>({...d,idleFrameIndex:0})),W("idle");const s=oe+Math.random()*(je-oe);e=setTimeout(()=>{W(Math.random()<.5?"walk":"run")},s)}},Oe);return()=>{clearInterval(i),e&&clearTimeout(e)}},[c,m.length]),t.useEffect(()=>{if(m.length>0)return;const e=setInterval(()=>{c==="walk"&&Math.random()<ce&&W("run"),c==="run"&&Math.random()<ce&&W("walk")},$e);return()=>clearInterval(e)},[c,m.length]);const Me=ge%$,Ee=b*C,J=xe%Ee,j=n?.cols!=null&&n?.rows!=null,Ie=j?J%(n.cols??1):0,_e=j?Math.floor(J/(n.cols??1)):0,We=Math.min(1+T*.5,1.5),Q=`translateX(${X}px) scale(${We})${me==="left"?" scaleX(-1)":""}`,A=m.length>0,Y=l&&{transform:Q,transformOrigin:"bottom left",width:l.frameWidth,height:l.frameHeight,backgroundImage:"url(/cat-walk.webp)",backgroundPosition:`${-Math.round(Me*l.frameWidth)}px 0`,backgroundSize:`${l.sheetWidth}px ${l.sheetHeight}px`,opacity:c==="run"||A?1:0,pointerEvents:c==="run"||A?"auto":"none"},Z=n&&{transform:Q,transformOrigin:"bottom left",width:n.frameWidth,height:n.frameHeight,backgroundImage:"url(/cat-idle.webp)",backgroundPosition:j?`${-Math.round(Ie*n.frameWidth)}px ${-Math.round(_e*n.frameHeight)}px`:"0 0",backgroundSize:`${n.sheetWidth}px ${n.sheetHeight}px`,opacity:!A&&(c==="walk"||c==="idle")?1:0,pointerEvents:!A&&(c==="walk"||c==="idle")?"auto":"none"},ee=r==="onBar",S=n??l;return h.jsxs(h.Fragment,{children:[r==="falling"&&S&&h.jsx("div",{className:E.fallingCatWrap,"aria-hidden":!0,children:h.jsx("div",{className:E.cat,style:{width:S.frameWidth,height:S.frameHeight,backgroundImage:"url(/cat-idle.webp)",backgroundPosition:"0 0",backgroundSize:`${S.sheetWidth}px ${S.sheetHeight}px`,backgroundRepeat:"no-repeat",imageRendering:"pixelated"}})}),r==="onBar"&&m.map(e=>h.jsx("div",{className:E.fallingMeatWrap,style:{left:`${e.x}px`},"aria-hidden":!0,children:h.jsx("span",{className:E.fallingMeatEmoji,children:Ne})},e.id)),h.jsxs("div",{ref:_,className:E.bar,style:r==="hidden"?{pointerEvents:"none",cursor:"default"}:void 0,onClick:r==="onBar"?V:void 0,onKeyDown:r==="onBar"?e=>e.key==="Enter"&&V():void 0,role:r==="onBar"?"button":void 0,tabIndex:r==="onBar"?0:void 0,"aria-label":r==="onBar"?"é»æ“Šéš¨æ©Ÿåˆ‡æ›è²“çš„ç‹€æ…‹ï¼šèµ°è·¯ã€è·‘æ­¥ã€ç«™ç«‹":void 0,children:[ee&&l&&Y&&h.jsx("div",{className:E.cat,style:Y,"aria-hidden":!0}),ee&&n&&Z&&h.jsx("div",{className:E.cat,style:Z,"aria-hidden":!0})]})]})}export{Pe as WalkCat};
